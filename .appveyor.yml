# This file is based on
# https://github.com/Ifsttar/I-Simpa/blob/master/appveyor.yml

image:
 - Visual Studio 2017


# clone directory
clone_folder: c:\projects\wxMaxima


# cache the build results in order to speed up the build
#cache:
#  - build\CMakeFiles

# branches to build
branches:
  only:
    - master

# scripts to run before build
before_build:
  - cmd: echo Downloading and unpacking wxWidgets...
  - cmd: set WXWIN=C:/wxWidgets
  - ps: Start-FileDownload 'https://github.com/wxWidgets/wxWidgets/releases/download/v3.1.2/wxMSW-3.1.2_vc141_x64_ReleaseDLL.7z'
  - ps: Start-FileDownload 'https://github.com/wxWidgets/wxWidgets/releases/download/v3.1.2/wxWidgets-3.1.2-headers.7z'
  - ps: Start-FileDownload 'https://github.com/wxWidgets/wxWidgets/releases/download/v3.1.2/wxMSW-3.1.2_vc141_x64_Dev.7z'
  - ps: Start-FileDownload 'https://github.com/wxWidgets/wxWidgets/releases/download/v3.1.2/wxMSW-3.1.2_vc141_x64_ReleasePDB.7z'
  - ps: Start-FileDownload 'https://github.com/wxWidgets/wxWidgets/releases/download/v3.1.2/wxWidgets-3.1.2.7z'
  - cmd: 7z x wxWidgets-3.1.2-headers.7z -o%WXWIN%
  - cmd: 7z x wxMSW-3.1.2_vc141_x64_ReleaseDLL.7z -o%WXWIN%
  - cmd: 7z x wxMSW-3.1.2_vc141_x64_ReleasePDB.7z -o%WXWIN%
  - cmd: 7z x wxMSW-3.1.2_vc141_x64_Dev.7z -o%WXWIN%
  - cmd: echo "compiling wxwidgets from source"
  - cmd: 7z x wxWidgets-3.1.2.7z -oC:\wxwidgets-source
  - cmd: mkdir C:\wxwidgets-build
  - cmd: cd C:\wxwidgets-build
  - cmd: CALL "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"
  - cmd: cmake -LAH -G "Visual Studio 15 2017 Win64" -DwxBUILD_SHARED=NO --config Release -DCMAKE_INSTALL_PREFIX=C:\wxwidgets-install ../wxwidgets-source
  - cmd: cmake --build . --config Release
  - cmd: cmake --build . --config Release --target install
  - cmd: ls %WXWIN%
  - cmd: echo Running cmake...
  - cmd: if not exist c:\projects\wxMaxima\build mkdir c:\projects\wxMaxima\build
  - cmd: cd c:\projects\wxMaxima\build
  - cmd: cmake  -LAH -G "Visual Studio 15 2017 Win64" -DAPPVEYOR_BUILD=1 --config Release -DwxWidgets_ROOT_DIR=C:\wxwidgets-install -D CMAKE_CXX_FLAGS="/EHsc /D_UNICODE=1" -DwxWidgets_CONFIGURATION=mswu ..

build_script:
  - cmd: cd c:\projects\wxMaxima\build
  - cmd: cmake --build . --config Release

after_build:
  - cmd: cd c:\projects\wxMaxima\build
  - cmd: CALL "C:\Program Files (x86)\Microsoft Visual Studio\2017\Community\VC\Auxiliary\Build\vcvars64.bat"
  - cpack -G NSIS
  - cmd: msbuild "PACKAGE.vcxproj" /consoleloggerparameters:Verbosity=normal /target:Build /logger:"C:\Program Files\AppVeyor\BuildAgent\Appveyor.MSBuildLogger.dll"

on_failure:
  - cmd: 7z a FailureDump.zip *
  - cmd: appveyor PushArtifact FailureDump.zip

artifacts:
  - path: 'build/wxmaxima-*.exe'
    name: wxMaxima_Installer
